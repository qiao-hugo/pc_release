<html>
<head>
		<title>T云版本升级价格计算器</title>
        <meta http-equiv=Content-Type content="text/html; charset=gb2312">
        <script src="../js/jquery-2.1.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <link href="../css/bootstrap.min.css" rel="stylesheet" />
        <link href="../css/bootstrap-datepicker.min.css" rel="stylesheet" />
        <link href="../css/font-awesome.min.css" rel="stylesheet" />
        <link rel="stylesheet" type="text/css" media="all" href="../css/daterangepicker-bs3.css" />
        <script type="text/javascript" src="../js/moment.js"></script>
        <script type="text/javascript" src="../js/daterangepicker.js"></script>

</head>
<body>
<div id="div_upgrade_determine_input" class="container-fluid w fix rowFrame" style='padding-bottom:0;padding-top: 50px;'>
    <div style="display: flex; justify-content: space-around;flex-wrap: wrap;">
        <div  style="padding: 10px;border:1px solid #ddd">
            <div class="add-visit">
                <div class="form-group fix">
                    <div class="input-group" >
                        <div class="input-group-addon">T云客户端升级</div>
                    </div>
                </div>
                <div class="form-group fix">
                    <div class="input-group" >
                        <div class="input-group-addon">T云账号</div>
                        <input type="text" data-toggle="popover" data-placement="bottom" placeholder="输入T云账号" style="width: 310px"
                               data-content="T云账号不能为空" id="tyun_account" class="form-control keyInput">
                        <div class="input-group-addon" onclick="searchTyunBuyServiceInfo()" id="searchTyunBuyServiceInfo" ><i id="searchTyunBuyServiceInfo_li" class="fa icon-search" aria-hidden="true" onclick="searchTyunBuyServiceInfo(1)"></i></div>
                    </div>
                </div>
                <div class="form-group fix" style="margin-bottom: 0px;">
                    <label style="font-weight: bold;">客户名称</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="customername_display" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>
                <!--<div class="form-group fix" style="margin-bottom: 0px;">
                    <label style="font-weight: bold;">原合同</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="contractcode_display" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>-->
                <div class="form-group fix" style="margin-bottom: 0px;">
                    <label style="font-weight: bold;">合同总额</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="total_display" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>
                <div class="form-group fix" style="margin-bottom: 0px;">
                    <label style="font-weight: bold;">原版本</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="productname_display" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>
                <div class="form-group fix" style="margin-bottom: 0px;">
                    <label style="font-weight: bold;">到期时间</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="expiredate_display" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>
                <div class="form-group fix" style="margin-bottom: 10px;">
                    <label style="font-weight: bold;">购买价格</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="price_display" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>

                <div class="form-group fix">
                    <div class="input-group">
                        <div class="input-group-addon">升级版本</div>

                        <select id="productid" style="width: 340px" name="productid" class="form-control" onchange="select_product(this.options[this.options.selectedIndex].value);"  data-toggle="popover" data-placement="bottom" data-content="产品必选">
                            <option value='' selected>请选择版本</option>
                        </select>
                    </div>
                </div>
                <div class="form-group fix">
                    <div class="input-group">
                        <div class="input-group-addon">升级年限</div>
                        <select id="productlife" style="width: 340px" name="productlife" class="form-control" onchange="select_year(this.options[this.options.selectedIndex].value);" data-toggle="popover" data-placement="bottom" data-content="年限必选">
                            <optgroup>
                                <option value="1" selected>1年</option>
                                <option value="2">2年</option>
                                <option value="3">3年</option>
                                <option value="4">4年</option>
                                <option value="5">5年</option>
                                <option value="6">6年</option>
                                <option value="7">7年</option>
                                <option value="8">8年</option>
                                <option value="9">9年</option>
                                <option value="10">10年</option>
                                {/if}
                            </optgroup>
                        </select>
                        <input type="hidden" id="plpre" value="">
                    </div>
                </div>

                <div class="form-group fix">
                    <div class="input-group">
                        <div class="input-group-addon">升级日期</div>
                        <div class="input-prepend input-group">
                            <input type="text" readonly style="width: 300px" name="upgradedate" id="upgradedate" class="form-control" value="2018/07/05" />
                            <span class="add-on input-group-addon"><i class="glyphicon glyphicon-calendar fa fa-calendar"></i></span>
                        </div>
                    </div>
                </div>

                <div class="confirm tc" style="text-align: center;">
                    <input type="button" class="btn" data-toggle="popover" data-placement="top" style="width: 100%;font-size: 20px;font-weight: 800;" value="开始计算" onclick="calcTyunUpgradeCost()" id="btn_tyun_calculator">
                </div>
                <div class="form-group fix">
                    <div class="input-group">
                        使用说明：<br>
                        1、输入T云账号按回车或点击查询图标查询原版本以及可升级版本<br>
                        2、选择可升级版本、升级年限和升级日期<br>
                        3、点击开始计算按钮即可查询结果<br>
                    </div>
                </div>
            </div>
        </div>
        <div style="padding: 10px;border:1px solid #ddd">
            <div class="add-visit">
                <div class="form-group fix">
                    <div class="input-group" >
                        <div class="input-group-addon">T云WEB端升级</div>
                    </div>
                </div>
                <div class="form-group fix">
                    <div class="input-group">
                        <div class="input-group-addon">产品分类</div>
                        <select id="classtyperenew" style="width: 340px" name="classtyperenew" class="form-control"   data-toggle="popover" data-placement="bottom" data-content="产品必选">
                        </select>
                    </div>
                </div>
                <div class="form-group fix">
                    <div class="input-group" >
                        <div class="input-group-addon">T云账号</div>
                        <input type="text" data-toggle="popover" data-placement="bottom" placeholder="输入T云账号" style="width: 310px"
                               data-content="T云账号不能为空" id="tyun_account1" class="form-control keyInput">
                        <div class="input-group-addon" onclick="searchTyunBuyServiceInfo1()" id="searchTyunBuyServiceInfo1" ><i id="searchTyunBuyServiceInfo_li1" class="fa icon-search" aria-hidden="true" onclick="searchTyunBuyServiceInfo1()"></i></div>
                    </div>
                </div>
                <div class="form-group fix" style="margin-bottom: 0px;">
                    <label style="font-weight: bold;">客户名称</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="customername_display1" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>
                <!--<div class="form-group fix" style="margin-bottom: 0px;">
                    <label style="font-weight: bold;">原合同</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="contractcode_display" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>-->
                <!--<div class="form-group fix" style="margin-bottom: 0px;">
                    <label style="font-weight: bold;">合同总额</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="total_display1" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>-->
                <div class="form-group fix" style="margin-bottom: 0px;">
                    <label style="font-weight: bold;">原版本</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="productname_display1" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>
                <div class="form-group fix" style="margin-bottom: 0px;">
                    <label style="font-weight: bold;">到期时间</label>
                    <input type="hidden" id="oldproductid1" />
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="expiredate_display1" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>
                <div class="form-group fix" style="margin-bottom: 10px;">
                    <label style="font-weight: bold;">购买价格</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="price_display1" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>

                <div class="form-group fix">
                    <div class="input-group">
                        <div class="input-group-addon">升级版本</div>
                        <input id="userid" type="hidden" value="">
                        <select id="productid1" style="width: 340px" name="productid1" class="form-control"   data-toggle="popover" data-placement="bottom" data-content="产品必选">
                            <option value='' selected>请选择版本</option>
                        </select>
                    </div>
                </div>
                <div class="form-group fix">
                    <div class="input-group">
                        <div class="input-group-addon">升级年限</div>
                        <select id="productlife1" style="width: 340px" name="productlife1" class="form-control" data-toggle="popover" data-placement="bottom" data-content="年限必选">
                            <optgroup>
                                <option value="1" selected>1年</option>
                                <option value="2">2年</option>
                                <option value="3">3年</option>
                                <option value="4">4年</option>
                                <option value="5">5年</option>
                                <option value="6">6年</option>
                                <option value="7">7年</option>
                                <option value="8">8年</option>
                                <option value="9">9年</option>
                                <option value="10">10年</option>
                                {/if}
                            </optgroup>
                        </select>
                        <input type="hidden" id="plpre1" value="">
                    </div>
                </div>

                <!-- <div class="form-group fix">
                    <div class="input-group">
                        <div class="input-group-addon">升级日期</div>
                        <div class="input-prepend input-group">
                            <input type="text" readonly style="width: 300px" name="upgradedate" id="upgradedate1" class="form-control" value="2018/07/05" />
                            <span class="add-on input-group-addon"><i class="glyphicon glyphicon-calendar fa fa-calendar"></i></span>
                        </div>
                    </div>
                </div>-->

                <div class="confirm tc" style="text-align: center;">
                    <input type="button" class="btn" data-toggle="popover" data-placement="top" style="width: 100%;font-size: 20px;font-weight: 800;" value="开始计算" onclick="calcTyunUpgradeCost1()">
                </div>
                <div class="form-group fix">
                    <div class="input-group">
                        使用说明：<br>
                        1、输入T云账号按回车或点击查询图标查询原版本以及可升级版本<br>
                        2、选择可升级版本、升级年限和升级日期<br>
                        3、点击开始计算按钮即可查询结果<br>
                    </div>
                </div>

            </div>
        </div>
        <div style="padding: 10px;border:1px solid #ddd">
            <div class="add-visit">
                <div class="form-group fix">
                    <div class="input-group" >
                        <div class="input-group-addon">T云WEB迁移升级</div>
                    </div>
                </div>
                <div class="form-group fix">
                    <div class="input-group" >
                        <div class="input-group-addon">T云账号</div>
                        <input type="text" data-toggle="popover" data-placement="bottom" placeholder="输入T云账号" style="width: 310px"
                               data-content="T云账号不能为空" id="tyun_account2" class="form-control keyInput">
                        <div class="input-group-addon" onclick="searchTyunBuyServiceInfo2()" id="searchTyunBuyServiceInfo2" ><i id="searchTyunBuyServiceInfo_li2" class="fa icon-search" aria-hidden="true" onclick="searchTyunBuyServiceInfo2(1)"></i></div>
                    </div>
                </div>
                <div class="form-group fix" style="margin-bottom: 0px;">
                    <label style="font-weight: bold;">客户名称</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="customername_display2" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>
                <!--<div class="form-group fix" style="margin-bottom: 0px;">
                    <label style="font-weight: bold;">原合同</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="contractcode_display" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>-->
                <div class="form-group fix" style="margin-bottom: 0px;">
                    <label style="font-weight: bold;">合同总额</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="total_display2" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>
                <div class="form-group fix" style="margin-bottom: 0px;">
                    <label style="font-weight: bold;">原版本</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="productname_display2" style="text-align: left;width: 100%;color: #428bca;"></label>
                        <input type="hidden" id="activecode2"/>
                        <input type="hidden" id="oldproductid2"/>
                        <input type="hidden" id="oldclosedate2"/>
                        <input type="hidden" id="contractno2"/>
                    </div>
                </div>
                <div class="form-group fix" style="margin-bottom: 0px;">
                    <label style="font-weight: bold;">到期时间</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="expiredate_display2" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>
                <div class="form-group fix" style="margin-bottom: 10px;">
                    <label style="font-weight: bold;">购买价格</label>
                    <div class="input-box" style="float: right;width: 78%;">
                        <label id="price_display2" style="text-align: left;width: 100%;color: #428bca;"></label>
                    </div>
                </div>

                <div class="form-group fix">
                    <div class="input-group">
                        <div class="input-group-addon">升级版本</div>
                        <select id="productid2" style="width: 340px" name="productid" class="form-control"  data-toggle="popover" data-placement="bottom" data-content="产品必选">
                            <option value='' selected>请选择版本</option>
                        </select>
                    </div>
                </div>
                <div class="form-group fix">
                    <div class="input-group">
                        <div class="input-group-addon">升级年限</div>
                        <select id="productlife2" style="width: 340px" name="productlife" class="form-control" data-toggle="popover" data-placement="bottom" data-content="年限必选">
                            <optgroup>
                                <option value="1" selected>1年</option>
                                <option value="2">2年</option>
                                <option value="3">3年</option>
                                <option value="4">4年</option>
                                <option value="5">5年</option>
                                <option value="6">6年</option>
                                <option value="7">7年</option>
                                <option value="8">8年</option>
                                <option value="9">9年</option>
                                <option value="10">10年</option>
                                {/if}
                            </optgroup>
                        </select>
                        <input type="hidden" id="plpre2" value="">
                    </div>
                </div>

                <div class="form-group fix">
                    <div class="input-group">
                        <div class="input-group-addon">升级日期</div>
                        <div class="input-prepend input-group">
                            <input type="text" readonly style="width: 300px" name="upgradedate" id="upgradedate2" class="form-control" value="2018/07/05" />
                            <span class="add-on input-group-addon"><i class="glyphicon glyphicon-calendar fa fa-calendar"></i></span>
                        </div>
                    </div>
                </div>

                <div class="confirm tc" style="text-align: center;">
                    <input type="button" class="btn" data-toggle="popover" data-placement="top" style="width: 100%;font-size: 20px;font-weight: 800;" value="开始计算" onclick="calcTyunUpgradeCost2()" id="btn_tyun_calculator2">
                </div>
                <div class="form-group fix">
                    <div class="input-group">
                        使用说明：<br>
                        1、输入T云账号按回车或点击查询图标查询原版本以及可升级版本<br>
                        2、选择可升级版本、升级年限和升级日期<br>
                        3、点击开始计算按钮即可查询结果<br>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

</div>
<script>
    var oldProductInfo = null;
    $(document).ready(function() {
        $('#upgradedate').daterangepicker({ singleDatePicker: true }, function(start, end, label) {
            console.log(start.toISOString(), end.toISOString(), label);
        });
        var myDate = new Date();
        var curDate=myDate.getFullYear()+"/"+(myDate.getMonth()*1+1)+"/"+myDate.getDate();
        $("#upgradedate").val(curDate);
    });
    $("#searchTyunBuyServiceInfo_li").click(function(event){
        event.stopPropagation();//阻止事件冒泡即可
    });
    $('#tyun_account').bind('keypress',function(event){
        if(event.keyCode == "13"){
            var tyun_account = $("#tyun_account").val();
            if(tyun_account == ""){
                return;
            }
            searchTyunBuyServiceInfo();
        }
    });

    function searchTyunBuyServiceInfo() {
        var tyun_account = $("#tyun_account").val();
        if(tyun_account == ""){
            alert("输入T云账号");
        }

        $("#customername_display").text('');
        $("#contractcode_display").text('');
        $("#total_display").text('');
        $("#productname_display").text('');
        $("#expiredate_display").text('');
        $("#price_display").text('');
        oldProductInfo=null;

        $.ajax({
            url: "/index.php?module=Home&action=BasicAjax&mode=searchTyunBuyServiceInfo&tyun_account="+tyun_account,
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                if(data.success){
                    var d = data.result;
                    $("#customername_display").text(d.customername);
                    $("#contractcode_display").text(d.contractname);
                    $("#total_display").text(d.total);
                    $("#productname_display").text(d.productname);
                    $("#expiredate_display").text(d.expiredate);
                    $("#price_display").text(d.unit_price);

                    searchTyunUpgradeProduct(d.productid);

                    oldProductInfo = d;
                }else{
                    alert("查询数据出错");
                }
            }
        });
    }

    //获取升级版本
    function searchTyunUpgradeProduct(productid) {
        //初始化升级版本
        $("#productid").empty();
        var str_html = "";
        $("#productid").append(str_html);

        $("#btn_tyun_calculator").removeAttr("disabled");
        $.ajax({
            url: "/index.php?module=Home&action=BasicAjax&mode=searchTyunUpgradeProduct&p_productid="+productid,
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                if(data.success){
                    if(data.result.length == 0){
                        alert('未查询到对应升级版本');
                        $("#btn_tyun_calculator").attr("disabled","disabled");
                    }else{
                        initUpgradeProductList(data.result);
                    }
                }
            }
        });
    }
    //初始化产品
    function initUpgradeProductList(productList) {
        $("#productid").empty();
        var str_html = "";
        for(var i=0;i<productList.length;i++){
            str_html += "<option data-renewprice='"+ productList[i]['renew_price']+"' data-price='"+ productList[i]['unit_price']+"' value='"+ productList[i]['productid'] +"'>"+ productList[i]['productname'] +"</option>";
        }
        $("#productid").append(str_html);
    }

    function calcTyunUpgradeCost() {
        //升级费用= （高版本首年购买价格-原版本首年购买价格）+（高版本续费价格*升级年限-1）- 剩余价格
        //剩余价格=  有效期内合同总金额/合同总时长*剩余服务天数
        if(oldProductInfo == null){
            alert('请先输入T云账号查询购买信息');
            return;
        }

        //原版本首年购买价格
        var oldProductsPrice = oldProductInfo.unit_price;
        //高版本首年购买价格
        var newProductsPrice = $("#productid").find("option:selected").attr("data-price");
        //高版本续费价格
        var newProductsRewnewPrice = $("#productid").find("option:selected").attr("data-renewprice");
        //升级年限
        var upgradeYear = $("#productlife").find("option:selected").val();

        //剩余价格=  有效期内合同总金额/合同总时长*剩余服务天数
        //合同总金额
        var contractsTotal = oldProductInfo.total;
        //合同总时长
        var activedate = oldProductInfo.activedate;
        var expiredate = oldProductInfo.expiredate;
        var strDate1=activedate.replace(/-/g,'/');
        var strDate2=expiredate.replace(/-/g,'/');
        var totalDays = daysBetween(strDate1,strDate2);

        //剩余服务天数
        //var myDate = new Date();
       // var curDate=myDate.getFullYear()+"/"+(myDate.getMonth()*1+1)+"/"+myDate.getDate();
        var upgradedate = $("#upgradedate").val();
        var surplusDays = daysBetween(upgradedate,strDate2);

        //剩余价格=  有效期内合同总金额/合同总时长*剩余服务天数
        var surplusPrice = FloatMul(FloatDiv(contractsTotal,totalDays),surplusDays);
        surplusPrice = surplusPrice.toFixed(2);

        //升级费用= （高版本首年购买价格-原版本首年购买价格）+（高版本续费价格*升级年限-1）- 剩余价格
        var upgradeCost =  FloatSub(newProductsPrice,oldProductsPrice);
        upgradeCost =  FloatAdd(upgradeCost,FloatMul(newProductsRewnewPrice,FloatSub(upgradeYear,1)));
        upgradeCost =  FloatSub(upgradeCost,surplusPrice);
        alert("预计升级费用为："+ upgradeCost)
    }





    ////TWEB端升级
    $(document).ready(function() {
        $('#upgradedate1').daterangepicker({ singleDatePicker: true }, function(start, end, label) {
            console.log(start.toISOString(), end.toISOString(), label);
        });
        var myDate = new Date();
        var curDate=myDate.getFullYear()+"/"+(myDate.getMonth()*1+1)+"/"+myDate.getDate();
        $("#upgradedate1").val(curDate);
    });
    $("#searchTyunBuyServiceInfo_li1").click(function(event){
        event.stopPropagation();//阻止事件冒泡即可
    });
    $('#tyun_account1').bind('keypress',function(event){
        if(event.keyCode == "13"){
            var tyun_account = $("#tyun_account2").val();
            if(tyun_account == ""){
                return;
            }
            searchTyunBuyServiceInfo1();
        }
    });

    function searchTyunBuyServiceInfo1() {
        var tyun_account = $("#tyun_account1").val();
        var classtyperenew = $("#classtyperenew").val();
        if(tyun_account == ""){
            alert("输入T云账号");
            return;
        }
        if(classtyperenew == ""){
            alert("选择产品分类");
            return;
        }

        $("#customername_display1").text('');
        $("#contractcode_display1").text('');
        $("#total_display1").text('');
        $("#productname_display1").text('');
        $("#expiredate_display1").text('');
        $("#price_display1").text('');
        oldProductInfo1=null;

        $.ajax({
            url: "/index.php?module=Home&action=BasicAjax&mode=searchTyunBuyServiceInfo1&tyun_account="+tyun_account+"&classtyperenew="+classtyperenew,
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                if(data.success){
                    var d = data;
                    $("#customername_display1").text(d.customername);
                    $("#contractcode_display1").text(d.contractname);
                    $("#total_display1").text(d.total);
                    $("#productname_display1").text(d.productname);
                    $("#expiredate_display1").text(d.expiredate);
                    $("#price_display1").text(d.unit_price);
                    $("#activecode1").val(d.activecode);
                    $("#oldproductid1").val(d.productid);
                    $("#userid").val(d.usercodeid);
                    $("#oldclosedate1").val(d.expiredate);
                    $("#contractno1").val(d.contractname);

                    $.each(data.plist,function(key,value){
                        var str='<option value="'+value.ID+'"> '+value.Title+'</option>'
                        $('#productid1').append(str);
                    })
                    //searchTyunUpgradeProduct1(d.productid);

                    oldProductInfo2 = d;
                }else{
                    alert("查询数据出错");
                }
            }
        });
    }

    //获取升级版本
    function searchTyunUpgradeProduct1(productid) {
        return;
        //初始化升级版本
        $("#productid1").empty();
        var str_html = "";
        $("#productid1").append(str_html);

        $("#btn_tyun_calculator1").removeAttr("disabled");
        $.ajax({
            url: "/index.php?module=Home&action=BasicAjax&mode=searchTyunUpgradeProduct1&p_productid="+productid,
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                if(data.success){
                    if(data.result.length == 0){
                        alert('未查询到对应升级版本');
                        $("#btn_tyun_calculator1").attr("disabled","disabled");
                    }else{
                        initUpgradeProductList1(data.result);
                    }
                }
            }
        });
    }
    function tyuninit(){
        $.ajax({
            url: "/index.php?module=Home&action=BasicAjax&mode=getAllCategory",
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                if(data.success){
                    $('#classtyperenew').empty();
                    $.each(data.data,function(key,value){
                        var str='<option value="'+value.ID+'"> '+value.Title+'</option>'
                        $('#classtyperenew').append(str);
                    })

                }
            }
        });
    }
    tyuninit();
    //初始化产品
    function initUpgradeProductList1(productList) {
        $("#productid1").empty();
        var str_html = "";
        for(var i=0;i<productList.length;i++){
            str_html += "<option  value='"+ productList[i]['ID'] +"'>"+ productList[i]['Title'] +"</option>";
        }
        $("#productid1").append(str_html);
    }

    function calcTyunUpgradeCost1() {
        //升级费用= （高版本首年购买价格-原版本首年购买价格）+（高版本续费价格*升级年限-1）- 剩余价格
        //剩余价格=  有效期内合同总金额/合同总时长*剩余服务天数
        var productid2=$('#productid1').val();
        var productlife2=$('#productlife1').val();
        var usercode=$('#tyun_account1').val();
        var activecode=$("#activecode1").val();
        var oldclosedate2=$("#oldclosedate1").val();
        var contractno2=$("#contractno1").val();
        var classtyperenew=$("#classtyperenew").val();
        var usercodeid=$("#userid").val();
        if(classtyperenew == ''){
            alert('请先选择产品类型');
            return;
        }
        if(usercodeid == ''){
            alert('请先输入T云账号查询购买信息');
            return;
        }
        if(productid2 == ''){
            alert('请先选择升级产品');
            return;
        }
        $.ajax({
            url: "/index.php?module=Home&action=BasicAjax&mode=getPrice1&productid="+productid2+"&buyyear="+productlife2+"&tyunusercode="+usercodeid,
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                if(data.success){
                    alert(data.data.money);
                }else{
                    alert(data.message);
                }

            }
        });
        return false;
    }







    ////TWEB端迁移升级
    $(document).ready(function() {
        $('#upgradedate2').daterangepicker({ singleDatePicker: true }, function(start, end, label) {
            console.log(start.toISOString(), end.toISOString(), label);
        });
        var myDate = new Date();
        var curDate=myDate.getFullYear()+"/"+(myDate.getMonth()*1+1)+"/"+myDate.getDate();
        $("#upgradedate2").val(curDate);
    });
    $("#searchTyunBuyServiceInfo_li2").click(function(event){
        event.stopPropagation();//阻止事件冒泡即可
    });
    $('#tyun_account2').bind('keypress',function(event){
        if(event.keyCode == "13"){
            var tyun_account = $("#tyun_account2").val();
            if(tyun_account == ""){
                return;
            }
            searchTyunBuyServiceInfo2();
        }
    });

    function searchTyunBuyServiceInfo2() {
        var tyun_account = $("#tyun_account2").val();
        if(tyun_account == ""){
            alert("输入T云账号");
        }

        $("#customername_display2").text('');
        $("#contractcode_display2").text('');
        $("#total_display2").text('');
        $("#productname_display2").text('');
        $("#expiredate_display2").text('');
        $("#price_display2").text('');
        oldProductInfo2=null;

        $.ajax({
            url: "/index.php?module=Home&action=BasicAjax&mode=searchTyunBuyServiceInfo2&tyun_account="+tyun_account,
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                if(data.success){
                    var d = data.result;
                    $("#customername_display2").text(d.customername);
                    $("#contractcode_display2").text(d.contractname);
                    $("#total_display2").text(d.total);
                    $("#productname_display2").text(d.productname);
                    $("#expiredate_display2").text(d.expiredate);
                    $("#price_display2").text(d.unit_price);
                    $("#activecode2").val(d.activecode);
                    $("#oldproductid2").val(d.productid);
                    $("#oldclosedate2").val(d.expiredate);
                    $("#contractno2").val(d.contractname);

                    searchTyunUpgradeProduct2(d.productid);

                    oldProductInfo2 = d;
                }else{
                    alert("查询数据出错");
                }
            }
        });
    }

    //获取升级版本
    function searchTyunUpgradeProduct2(productid) {
        //初始化升级版本
        $("#productid2").empty();
        var str_html = "";
        $("#productid2").append(str_html);

        $("#btn_tyun_calculator2").removeAttr("disabled");
        $.ajax({
            url: "/index.php?module=Home&action=BasicAjax&mode=searchTyunUpgradeProduct2&p_productid="+productid,
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                if(data.success){
                    if(data.result.length == 0){
                        alert('未查询到对应升级版本');
                        $("#btn_tyun_calculator2").attr("disabled","disabled");
                    }else{
                        initUpgradeProductList2(data.result);
                    }
                }
            }
        });
    }
    //初始化产品
    function initUpgradeProductList2(productList) {
        $("#productid2").empty();
        var str_html = "";
        for(var i=0;i<productList.length;i++){
            str_html += "<option  value='"+ productList[i]['ID'] +"'>"+ productList[i]['Title'] +"</option>";
        }
        $("#productid2").append(str_html);
    }

    function calcTyunUpgradeCost2() {
        //升级费用= （高版本首年购买价格-原版本首年购买价格）+（高版本续费价格*升级年限-1）- 剩余价格
        //剩余价格=  有效期内合同总金额/合同总时长*剩余服务天数
        if(oldProductInfo2 == null){
            alert('请先输入T云账号查询购买信息');
            return;
        }
        var productid2=$('#productid2').val();
        var productlife2=$('#productlife2').val();
        var usercode=$('#tyun_account2').val();
        var activecode=$("#activecode2").val();
        var productid=$("#oldproductid2").val();
        var oldclosedate2=$("#oldclosedate2").val();
        var contractno2=$("#contractno2").val();
        $.ajax({
            url: "/index.php?module=Home&action=BasicAjax&mode=getPrice2&p_productid="+productid2+"&buyyear="+productlife2+"&usercode="+usercode+'&activecode='+activecode+'&productid='+productid+'&oldclosedate='+oldclosedate2+'&contractno='+contractno2,
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                if(data.success){
                    alert(data.money);
                }else{
                    alert(data.message);
                };
            }
        });
        return false;
    }
    function daysBetween(sDate1,sDate2){
        var time1 = Date.parse(new Date(sDate1));
        var time2 = Date.parse(new Date(sDate2));
        var nDays = Math.abs(parseInt((time2 - time1)/1000/3600/24));
        return  nDays;
    }
    //浮点数加法运算
    function FloatAdd(arg1,arg2){
        var r1,r2,m;
        try{r1=arg1.toString().split(".")[1].length}catch(e){r1=0}
        try{r2=arg2.toString().split(".")[1].length}catch(e){r2=0}
        m=Math.pow(10,Math.max(r1,r2));
        return (arg1*m+arg2*m)/m;
    }

    //浮点数减法运算
    function FloatSub(arg1,arg2){
        var r1,r2,m,n;
        try{r1=arg1.toString().split(".")[1].length}catch(e){r1=0}
        try{r2=arg2.toString().split(".")[1].length}catch(e){r2=0}
        m=Math.pow(10,Math.max(r1,r2));
        //动态控制精度长度
        n=(r1>r2)?r1:r2;
        return ((arg1*m-arg2*m)/m).toFixed(n);
    }

    //浮点数乘法运算
    function FloatMul(arg1,arg2)
    {
        var m=0,s1=arg1.toString(),s2=arg2.toString();
        try{m+=s1.split(".")[1].length}catch(e){}
        try{m+=s2.split(".")[1].length}catch(e){}
        return Number(s1.replace(".",""))*Number(s2.replace(".",""))/Math.pow(10,m);
    }
    //浮点数除法运算
    function FloatDiv(arg1,arg2){
        var t1=0,t2=0,r1,r2;
        try{t1=arg1.toString().split(".")[1].length}catch(e){}
        try{t2=arg2.toString().split(".")[1].length}catch(e){}
        with(Math){
            r1=Number(arg1.toString().replace(".",""));
            r2=Number(arg2.toString().replace(".",""));
            return (r1/r2)*pow(10,t2-t1);
        }
    }
</script>
</body>
</html>